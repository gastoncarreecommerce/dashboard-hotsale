<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HotSale - Pedidos acumulados hora a hora</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { color-scheme: light dark; --bg:#0b0b0c; --card:#151618; --text:#f8f8f8; --muted:#999; --accent:#4fa3ff; }
    body { margin:0; font-family: "Inter", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    select { background: var(--card); border: 1px solid #333; color: var(--text); padding: 6px 10px; border-radius: 8px; }
    .grid { display:grid; gap:16px; }
    .g-2 { grid-template-columns: 1fr 1fr; }
    .card { background: var(--card); border-radius: 16px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.4); }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse: collapse; font-size:14px; margin-top:8px; }
    th, td { padding: 6px 0; border-top:1px solid rgba(255,255,255,.08); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.delta.plus { color:#5ff97c; }
    td.delta.minus { color:#ff6f6f; }
    canvas { width:100%!important; height:350px!important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“Š HotSale - Pedidos acumulados hora a hora</h1>

    <div style="margin-bottom:16px">
      <label>SeleccionÃ¡ dÃ­a:</label>
      <select id="day-select"><option value="">â€”</option></select>
    </div>

    <div class="grid g-2">
      <div class="card">
        <h3 style="margin-top:0">Pedidos acumulados</h3>
        <canvas id="chartAccum"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Incremento por hora</h3>
        <canvas id="chartDelta"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Detalle hora a hora</h3>
      <table id="hour-table">
        <thead>
          <tr><th>Hora</th><th>Pedidos acumulados</th><th>VariaciÃ³n vs. hora anterior</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:6px">Zona horaria: America/Argentina/Buenos_Aires</div>
    </div>
  </div>

  <script>
    const TZ = "America/Argentina/Buenos_Aires";
    const MAP = { dateTime: "Creation Date", orderId: "Order" };
    let RAW_ROWS = [];
    let DAYS = {};

    const dateKey = d => {
      const parts = new Intl.DateTimeFormat("en-CA",{ timeZone:TZ, year:"numeric",month:"2-digit",day:"2-digit"}).formatToParts(new Date(d));
      const o = Object.fromEntries(parts.map(p=>[p.type,p.value]));
      return `${o.year}-${o.month}-${o.day}`;
    };
    const hourKey = d => {
      const parts = new Intl.DateTimeFormat("en-CA",{ timeZone:TZ, hour:"2-digit", hour12:false}).formatToParts(new Date(d));
      return Object.fromEntries(parts.map(p=>[p.type,p.value])).hour;
    };
    const toDM = iso => { const [y,m,d]=iso.split("-"); return `${d}/${m}`; };

    // Carga automÃ¡tica del CSV desde /data/hotsale.csv
    window.addEventListener("DOMContentLoaded", ()=>{
      Papa.parse("/data/hotsale.csv", {
        download:true, header:true, delimiter:";", skipEmptyLines:true,
        complete:(res)=>{ RAW_ROWS=res.data; buildIndex(); },
        error:(err)=>console.error("Error cargando CSV:",err)
      });
    });

    function buildIndex(){
      DAYS={};
      for(const r of RAW_ROWS){
        const dt=r[MAP.dateTime], id=(r[MAP.orderId]??"").toString().trim();
        if(!dt||!id)continue;
        const dk=dateKey(dt), hk=hourKey(dt);
        DAYS[dk] ??= {}; DAYS[dk][hk] ??= new Set(); DAYS[dk][hk].add(id);
      }
      const list=Object.keys(DAYS).sort();
      const sel=document.getElementById("day-select");
      sel.innerHTML=list.map(d=>`<option value="${d}">${toDM(d)}</option>`).join("");
      if(list.length){ sel.value=list[list.length-1]; renderDay(sel.value); }
      sel.onchange=()=> renderDay(sel.value);
    }

    let chart1, chart2;
    function renderDay(dateISO){
      const table=document.querySelector("#hour-table tbody");
      table.innerHTML="";
      const hours=[...Array(24).keys()].map(h=>String(h).padStart(2,"0"));
      const totals=[], deltas=[];
      let acc=0, prev=0;

      for(const h of hours){
        const count=DAYS[dateISO]?.[h]?.size||0;
        acc+=count; 
        const diff=acc-prev; prev=acc;
        totals.push(acc); deltas.push(diff);
        const td=`<td>${h}:00</td><td>${acc}</td><td class="delta ${diff>0?"plus":diff<0?"minus":""}">${diff>0?"+":""}${diff}</td>`;
        table.insertAdjacentHTML("beforeend",`<tr>${td}</tr>`);
      }

      const labels=hours.map(h=>h+":00");
      if(chart1)chart1.destroy(); if(chart2)chart2.destroy();
      chart1=new Chart(document.getElementById("chartAccum"),{
        type:"line",
        data:{labels,datasets:[{label:"Acumulado",data:totals,borderColor:"#4fa3ff",tension:.3}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{precision:0}}}}
      });
      chart2=new Chart(document.getElementById("chartDelta"),{
        type:"bar",
        data:{labels,datasets:[{label:"Incremento",data:deltas,backgroundColor:"#5ff97c"}]},
        options:{responsive:true,maintainAspectRatio:false,scales:{y:{ticks:{precision:0}}}}
      });
    }
  </script>
</body>
</html>
