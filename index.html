<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HotSale 2025 - Dashboard de Ventas</title>

  <!-- LibrerÃ­as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { color-scheme: light dark; --bg:#0b0b0c; --card:#151618; --text:#f8f8f8; --muted:#999; --accent:#4fa3ff; }
    body { margin:0; font-family: "Inter", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .bar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
    label { font-size:13px; color:var(--muted); }
    select, input[type="number"] {
      background: var(--card); border: 1px solid #333; color: var(--text);
      padding: 6px 10px; border-radius: 8px; min-width:120px;
    }
    .grid { display:grid; gap:16px; }
    .g-2 { grid-template-columns: 1fr 1fr; }
    .card { background: var(--card); border-radius: 16px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.4); }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse: collapse; font-size:14px; margin-top:8px; }
    th, td { padding: 6px 0; border-top:1px solid rgba(255,255,255,.08); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.delta.plus { color:#5ff97c; }
    td.delta.minus { color:#ff6f6f; }
    canvas { width:100%!important; height:350px!important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“Š HotSale 2025 - Dashboard de Ventas</h1>

    <div class="bar">
      <div>
        <label for="day-select">DÃ­a:</label><br>
        <select id="day-select"><option value="">â€”</option></select>
      </div>
      <div>
        <label for="offset-hours">Ajuste horario (en horas):</label><br>
        <input id="offset-hours" type="number" value="0" step="1">
      </div>
      <div class="muted">
        Los datos se ajustan automÃ¡ticamente a la hora argentina (UTCâˆ’3).  
        UsÃ¡ el offset si tu corte de dÃ­a difiere (ej. cierre a las 6 AM).
      </div>
    </div>

    <div class="grid g-2">
      <div class="card">
        <h3 style="margin-top:0">Pedidos acumulados</h3>
        <canvas id="chartAccum"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Incremento por hora</h3>
        <canvas id="chartDelta"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Detalle hora a hora</h3>
      <table id="hour-table">
        <thead>
          <tr><th>Hora</th><th>Pedidos acumulados</th><th>VariaciÃ³n vs. hora anterior</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:6px">
        Cada pedido se cuenta una sola vez (deduplicado por ID).  
        Timestamps convertidos de UTC â†’ Hora Argentina (UTCâˆ’3).
      </div>
    </div>
  </div>

  <script>
    const MAP = { dateTime: "Creation Date", orderId: "Order" };
    let RAW_ROWS = [];
    let DAYS = {};
    let ORDER_MAP = new Map();
    let offsetHours = 0;

    const cleanId = id => (id ?? "")
      .toString()
      .trim()
      .replace(/-0*1$/, "")
      .replace(/\s+/g, "");

    // âœ… Parse UTC â†’ hora Argentina (UTCâˆ’3) + offset manual
    const applyOffset = (raw) => {
      if (!raw) return null;
      const d = new Date(raw);
      if (isNaN(d)) return null;
      const local = new Date(d.getTime() - 3 * 60 * 60 * 1000);
      return new Date(local.getTime() + offsetHours * 60 * 60 * 1000);
    };

    const dateKey = (d) => {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Argentina/Buenos_Aires",
        year:"numeric", month:"2-digit", day:"2-digit"
      }).formatToParts(d);
      const o = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return `${o.year}-${o.month}-${o.day}`;
    };

    const hourKey = (d) => {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: "America/Argentina/Buenos_Aires",
        hour:"2-digit", hour12:false
      }).formatToParts(d);
      const o = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return o.hour;
    };

    const toDM = (iso) => {
      const [y,m,d] = iso.split("-");
      return `${d}/${m}`;
    };

    // Carga CSV automÃ¡ticamente
    window.addEventListener("DOMContentLoaded", () => {
      Papa.parse("/data/hotsale.csv", {
        download: true,
        header: true,
        delimiter: ";",
        skipEmptyLines: true,
        complete: (res) => {
          RAW_ROWS = res.data;
          rebuildAll();
        },
        error: (err) => console.error("Error cargando CSV:", err)
      });
    });

    document.getElementById("offset-hours").addEventListener("input", (e) => {
      offsetHours = Number(e.target.value) || 0;
      rebuildAll();
    });

    function rebuildAll() {
      buildOrderMap();
      buildIndex();
      renderDaySelector();
    }

    function buildOrderMap() {
      ORDER_MAP = new Map();
      for (const r of RAW_ROWS) {
        const rawDt = r[MAP.dateTime];
        const rawId = cleanId(r[MAP.orderId]);
        if (!rawDt || !rawId) continue;
        const dt = applyOffset(rawDt);
        if (!dt) continue;
        const prev = ORDER_MAP.get(rawId);
        if (!prev || dt < prev) ORDER_MAP.set(rawId, dt);
      }
    }

    function buildIndex() {
      DAYS = {};
      for (const [id, dt] of ORDER_MAP.entries()) {
        const dk = dateKey(dt);
        const hk = hourKey(dt);
        DAYS[dk] ??= {};
        DAYS[dk][hk] ??= new Set();
        DAYS[dk][hk].add(id);
      }
    }

    function renderDaySelector() {
      const sel = document.getElementById("day-select");
      const days = Object.keys(DAYS).sort();
      sel.innerHTML = days.map(d => `<option value="${d}">${toDM(d)} (${d})</option>`).join("");
      if (!days.length) return;
      if (!sel.value || !DAYS[sel.value]) sel.value = days[days.length - 1];
      renderDay(sel.value);
      sel.onchange = () => renderDay(sel.value);
    }

    let chartAccum, chartDelta;
    function renderDay(dateISO) {
      const tbody = document.querySelector("#hour-table tbody");
      tbody.innerHTML = "";
      const hours = [...Array(24).keys()].map(h => String(h).padStart(2,"0"));
      const totals = [], deltas = [];
      let acc = 0, prev = 0;

      for (const h of hours) {
        const count = DAYS[dateISO]?.[h]?.size || 0;
        acc += count;
        const diff = acc - prev;
        prev = acc;
        totals.push(acc);
        deltas.push(diff);
        const cls = diff > 0 ? "plus" : diff < 0 ? "minus" : "";
        const sign = diff > 0 ? "+" : "";
        tbody.insertAdjacentHTML("beforeend",
          `<tr><td>${h}:00</td><td>${acc}</td><td class="delta ${cls}">${sign}${diff}</td></tr>`);
      }

      const labels = hours.map(h => h+":00");
      if (chartAccum) chartAccum.destroy();
      if (chartDelta) chartDelta.destroy();

      chartAccum = new Chart(document.getElementById("chartAccum"), {
        type: "line",
        data: { labels, datasets: [{
          label: "Pedidos acumulados",
          data: totals,
          borderColor: "#4fa3ff",
          backgroundColor: "rgba(79,163,255,0.15)",
          fill: true,
          tension: 0.25
        }]},
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ precision:0 }}} }
      });

      chartDelta = new Chart(document.getElementById("chartDelta"), {
        type: "bar",
        data: { labels, datasets: [{
          label: "Incremento por hora",
          data: deltas,
          backgroundColor: deltas.map(v => v>0 ? "#5ff97c" : (v<0 ? "#ff6f6f" : "#777"))
        }]},
        options: { responsive:true, maintainAspectRatio:false, scales:{ y:{ ticks:{ precision:0 }}} }
      });
    }
  </script>
</body>
</html>
