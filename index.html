<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HotSale 2025 - Dashboard de Ventas</title>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { color-scheme: light dark; --bg:#0b0b0c; --card:#151618; --text:#f8f8f8; --muted:#999; --accent:#4fa3ff; }
    body { margin:0; font-family: "Inter", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .bar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
    label { font-size:13px; color:var(--muted); }
    select {
      background: var(--card); border: 1px solid #333; color: var(--text);
      padding: 6px 10px; border-radius: 8px; min-width:140px;
    }
    .grid { display:grid; gap:16px; }
    .g-2 { grid-template-columns: 1fr 1fr; }
    .card { background: var(--card); border-radius: 16px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.4); }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse: collapse; font-size:14px; margin-top:8px; }
    th, td { padding: 6px 0; border-top:1px solid rgba(255,255,255,.08); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.delta.plus { color:#5ff97c; }
    td.delta.minus { color:#ff6f6f; }
    canvas { width:100%!important; height:350px!important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìä HotSale 2025 - Dashboard de Ventas</h1>

    <div class="bar">
      <div>
        <label for="day-select">D√≠a (seg√∫n Creation Date):</label><br>
        <select id="day-select"><option value="">‚Äî</option></select>
      </div>
      <div class="muted">
        Los d√≠as se toman **tal cual vienen en la columna <code>Creation Date</code>** (solo la parte de fecha).  
        Sin conversiones de zona horaria ni ajustes autom√°ticos.
      </div>
    </div>

    <div class="grid g-2">
      <div class="card">
        <h3 style="margin-top:0">Pedidos acumulados</h3>
        <canvas id="chartAccum"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Incremento por hora</h3>
        <canvas id="chartDelta"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Detalle hora a hora</h3>
      <table id="hour-table">
        <thead>
          <tr><th>Hora</th><th>Pedidos acumulados</th><th>Variaci√≥n vs. hora anterior</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:6px">
        Cada pedido se cuenta una sola vez (deduplicado por ID normalizado).  
        D√≠a = primeros 10 caracteres de <code>Creation Date</code> (YYYY-MM-DD).  
        Hora = caracteres 11‚Äì12 de <code>Creation Date</code> (HH).
      </div>
    </div>
  </div>

  <script>
    // CONFIG
    const MAP = { dateTime: "Creation Date", orderId: "Order" };

    // ESTADO
    let RAW_ROWS = [];
    let ORDER_MAP = new Map(); // id limpio -> string fecha cruda
    let DAYS = {};             // d√≠a -> hora -> Set(orderIds)
    let chartAccum, chartDelta;

    // Normaliza el ID de pedido para dedupe (ej: saca sufijos "-01")
    const cleanId = (id) => (id ?? "")
      .toString()
      .trim()
      .replace(/-0*1$/, "")   // 123-01 -> 123
      .replace(/\s+/g, "");   // sin espacios

    // Toma "2025-05-12 23:57:10Z" ‚Üí "2025-05-12"
    const getDayFromRaw = (raw) => {
      if (!raw) return null;
      const s = raw.toString().trim();
      return s.slice(0, 10); // YYYY-MM-DD
    };

    // Toma "2025-05-12 23:57:10Z" ‚Üí "23"
    const getHourFromRaw = (raw) => {
      if (!raw) return null;
      const s = raw.toString().trim();
      // busca primero la parte de hora con regex
      const m = s.match(/(\d{2}):\d{2}:\d{2}/);
      if (m) return m[1]; // HH
      // fallback: posici√≥n fija
      return s.slice(11, 13);
    };

    const toDM = (iso) => {
      const [y,m,d] = iso.split("-");
      return `${d}/${m}`;
    };

    // CARGA INICIAL DEL CSV
    window.addEventListener("DOMContentLoaded", () => {
      Papa.parse("/data/hotsale.csv", {
        download: true,
        header: true,
        delimiter: ";",
        skipEmptyLines: true,
        complete: (res) => {
          RAW_ROWS = res.data;
          rebuildIndex();
        },
        error: (err) => console.error("Error cargando CSV:", err)
      });
    });

    function rebuildIndex() {
      buildOrderMap();
      buildDaysIndex();
      renderDaySelector();
    }

    // 1) DEDUPE: un solo registro por pedido (por ID normalizado) usando fecha m√°s temprana
    function buildOrderMap() {
      ORDER_MAP = new Map();
      for (const r of RAW_ROWS) {
        const rawId = cleanId(r[MAP.orderId]);
        const rawDate = r[MAP.dateTime];
        if (!rawId || !rawDate) continue;
        const day = getDayFromRaw(rawDate);
        const hour = getHourFromRaw(rawDate);
        if (!day || !hour) continue;
        const keyDateStr = `${day} ${hour}`; // para comparar lexicogr√°ficamente

        const prev = ORDER_MAP.get(rawId);
        if (!prev || keyDateStr < prev.key) {
          ORDER_MAP.set(rawId, { key: keyDateStr, raw: rawDate });
        }
      }
    }

    // 2) √çNDICE d√≠a √ó hora usando solo ORDER_MAP (ya deduplicado)
    function buildDaysIndex() {
      DAYS = {};
      for (const [id, obj] of ORDER_MAP.entries()) {
        const day = getDayFromRaw(obj.raw);
        const hour = getHourFromRaw(obj.raw);
        if (!day || !hour) continue;
        if (!DAYS[day]) DAYS[day] = {};
        if (!DAYS[day][hour]) DAYS[day][hour] = new Set();
        DAYS[day][hour].add(id);
      }
    }

    // 3) Selector de d√≠a
    function renderDaySelector() {
      const sel = document.getElementById("day-select");
      const days = Object.keys(DAYS).sort(); // YYYY-MM-DD
      sel.innerHTML = days.map(d => `<option value="${d}">${toDM(d)} (${d})</option>`).join("");
      if (!days.length) return;
      if (!sel.value || !DAYS[sel.value]) sel.value = days[days.length - 1];
      renderDay(sel.value);
      sel.onchange = () => renderDay(sel.value);
    }

    // 4) Render del d√≠a (tabla + gr√°ficos)
    function renderDay(dateISO) {
      const tbody = document.querySelector("#hour-table tbody");
      tbody.innerHTML = "";

      const hours = [...Array(24).keys()].map(h => String(h).padStart(2, "0"));
      const totals = [];
      const deltas = [];
      let acc = 0;
      let prev = 0;

      for (const h of hours) {
        const count = dateISO && DAYS[dateISO] && DAYS[dateISO][h]
          ? DAYS[dateISO][h].size
          : 0;
        acc += count;
        const diff = acc - prev;
        prev = acc;

        totals.push(acc);
        deltas.push(diff);

        const cls = diff > 0 ? "plus" : diff < 0 ? "minus" : "";
        const sign = diff > 0 ? "+" : "";
        tbody.insertAdjacentHTML(
          "beforeend",
          `<tr>
             <td>${h}:00</td>
             <td>${acc}</td>
             <td class="delta ${cls}">${sign}${diff}</td>
           </tr>`
        );
      }

      const labels = hours.map(h => h + ":00");

      if (chartAccum) chartAccum.destroy();
      if (chartDelta) chartDelta.destroy();

      chartAccum = new Chart(document.getElementById("chartAccum"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Pedidos acumulados",
            data: totals,
            borderColor: "#4fa3ff",
            backgroundColor: "rgba(79,163,255,0.15)",
            fill: true,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { precision: 0 } } },
          plugins: { legend: { display: false } }
        }
      });

      chartDelta = new Chart(document.getElementById("chartDelta"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Incremento por hora",
            data: deltas,
            backgroundColor: deltas.map(v =>
              v > 0 ? "#5ff97c" : (v < 0 ? "#ff6f6f" : "#777")
            )
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { precision: 0 } } },
          plugins: { legend: { display: false } }
        }
      });
    }
  </script>
</body>
</html>
