<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HotSale - Pedidos acumulados hora a hora</title>

  <!-- Librer√≠as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { color-scheme: light dark; --bg:#0b0b0c; --card:#151618; --text:#f8f8f8; --muted:#999; --accent:#4fa3ff; }
    body { margin:0; font-family: "Inter", system-ui, -apple-system, sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { margin: 0 0 12px; font-size: 22px; }
    .bar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px; }
    label { font-size:13px; color:var(--muted); }
    select, input[type="number"] {
      background: var(--card); border: 1px solid #333; color: var(--text);
      padding: 6px 10px; border-radius: 8px; min-width:120px;
    }
    .grid { display:grid; gap:16px; }
    .g-2 { grid-template-columns: 1fr 1fr; }
    .card { background: var(--card); border-radius: 16px; padding: 18px; box-shadow: 0 2px 10px rgba(0,0,0,.4); }
    .muted { color:var(--muted); font-size:13px; }
    table { width:100%; border-collapse: collapse; font-size:14px; margin-top:8px; }
    th, td { padding: 6px 0; border-top:1px solid rgba(255,255,255,.08); }
    th { text-align:left; color:var(--muted); font-weight:600; }
    td.delta.plus { color:#5ff97c; }
    td.delta.minus { color:#ff6f6f; }
    canvas { width:100%!important; height:350px!important; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üìä HotSale - Pedidos acumulados hora a hora</h1>

    <div class="bar">
      <div>
        <label for="day-select">D√≠a:</label><br>
        <select id="day-select"><option value="">‚Äî</option></select>
      </div>
      <div>
        <label for="offset-hours">Ajuste horario (en horas):</label><br>
        <input id="offset-hours" type="number" value="0" step="1">
      </div>
      <div class="muted">
        Si ves pedidos que aparecen como d√≠a 10 pero en realidad son del 11, prob√° con un offset
        (ej. +3 o -3) hasta que coincidan con tu corte de d√≠a.
      </div>
    </div>

    <div class="grid g-2">
      <div class="card">
        <h3 style="margin-top:0">Pedidos acumulados</h3>
        <canvas id="chartAccum"></canvas>
      </div>
      <div class="card">
        <h3 style="margin-top:0">Incremento por hora</h3>
        <canvas id="chartDelta"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Detalle hora a hora</h3>
      <table id="hour-table">
        <thead>
          <tr><th>Hora</th><th>Pedidos acumulados</th><th>Variaci√≥n vs. hora anterior</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted" style="margin-top:6px">
        Zona horaria: America/Argentina/Buenos_Aires. Cada pedido se cuenta solo una vez (dedupe por ID de pedido).
      </div>
    </div>
  </div>

  <script>
    const TZ = "America/Argentina/Buenos_Aires";

    // Columnas del CSV
    const MAP = { dateTime: "Creation Date", orderId: "Order" };

    let RAW_ROWS = [];
    let DAYS = {};              // √≠ndice d√≠a √ó hora
    let ORDER_MAP = new Map();  // orderId -> Date (√∫nico canonical para ese pedido)
    let offsetHours = 0;

    const applyOffset = (raw) => {
      const d = new Date(raw);
      if (Number.isNaN(d.getTime())) return null;
      return new Date(d.getTime() + offsetHours * 60 * 60 * 1000);
    };

    const dateKey = (d) => {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year:"numeric", month:"2-digit", day:"2-digit"
      }).formatToParts(d);
      const o = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return `${o.year}-${o.month}-${o.day}`;
    };

    const hourKey = (d) => {
      const parts = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        hour:"2-digit",
        hour12:false
      }).formatToParts(d);
      const o = Object.fromEntries(parts.map(p => [p.type, p.value]));
      return o.hour; // "00".."23"
    };

    const toDM = (iso) => {
      const [y,m,d] = iso.split("-");
      return `${d}/${m}`;
    };

    // 1) Carga el CSV ya desplegado en /data/hotsale.csv
    window.addEventListener("DOMContentLoaded", () => {
      Papa.parse("/data/hotsale.csv", {
        download: true,
        header: true,
        delimiter: ";",
        skipEmptyLines: true,
        complete: (res) => {
          RAW_ROWS = res.data;
          rebuildAll();
        },
        error: (err) => console.error("Error cargando CSV:", err)
      });
    });

    // Si cambian el offset, recalculamos todo
    document.getElementById("offset-hours").addEventListener("input", (e) => {
      offsetHours = Number(e.target.value) || 0;
      rebuildAll();
    });

    function rebuildAll() {
      buildOrderMap();  // dedupe
      buildIndex();     // llena DAYS
      renderDaySelector();
    }

    // 2) DEDUPE: cada Order se cuenta UNA sola vez
    function buildOrderMap() {
      ORDER_MAP = new Map();
      for (const r of RAW_ROWS) {
        const dtRaw = r[MAP.dateTime];
        const id = (r[MAP.orderId] ?? "").toString().trim();
        if (!dtRaw || !id) continue;

        const dt = applyOffset(dtRaw);
        if (!dt) continue;

        const prev = ORDER_MAP.get(id);
        // usamos la fecha/hora M√çNIMA como canonical (pod√©s cambiar a m√°xima si te conviene)
        if (!prev || dt < prev) {
          ORDER_MAP.set(id, dt);
        }
      }
    }

    // 3) Construye √≠ndice d√≠a√óhora usando SOLO ORDER_MAP (ya deduplicado)
    function buildIndex() {
      DAYS = {};
      for (const [id, dt] of ORDER_MAP.entries()) {
        const dk = dateKey(dt);
        const hk = hourKey(dt);
        if (!DAYS[dk]) DAYS[dk] = {};
        if (!DAYS[dk][hk]) DAYS[dk][hk] = new Set();
        DAYS[dk][hk].add(id);
      }
    }

    // 4) Dropdown de d√≠as
    function renderDaySelector() {
      const sel = document.getElementById("day-select");
      const days = Object.keys(DAYS).sort();
      sel.innerHTML = days.map(d => `<option value="${d}">${toDM(d)} (${d})</option>`).join("");
      if (!days.length) {
        renderDay(null);
        return;
      }
      if (!sel.value || !DAYS[sel.value]) {
        sel.value = days[days.length - 1]; // d√≠a m√°s reciente
      }
      renderDay(sel.value);
      sel.onchange = () => renderDay(sel.value);
    }

    // 5) Render de tabla + gr√°ficos
    let chartAccum, chartDelta;

    function renderDay(dateISO) {
      const tbody = document.querySelector("#hour-table tbody");
      tbody.innerHTML = "";

      const hours = [...Array(24).keys()].map(h => String(h).padStart(2,"0"));
      const totals = [];
      const deltas = [];
      let acc = 0;
      let prev = 0;

      for (const h of hours) {
        const count = dateISO && DAYS[dateISO] && DAYS[dateISO][h] ? DAYS[dateISO][h].size : 0;
        acc += count;
        const diff = acc - prev;
        prev = acc;
        totals.push(acc);
        deltas.push(diff);

        const cls = diff > 0 ? "plus" : (diff < 0 ? "minus" : "");
        const sign = diff > 0 ? "+" : "";
        const row = `
          <tr>
            <td>${h}:00</td>
            <td>${acc}</td>
            <td class="delta ${cls}">${sign}${diff}</td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      }

      const labels = hours.map(h => h + ":00");

      if (chartAccum) chartAccum.destroy();
      if (chartDelta) chartDelta.destroy();

      chartAccum = new Chart(document.getElementById("chartAccum"), {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Pedidos acumulados",
            data: totals,
            borderColor: "#4fa3ff",
            backgroundColor: "rgba(79,163,255,0.18)",
            fill: true,
            tension: 0.25
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { precision: 0 } } },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const idx = ctx.dataIndex;
                  const total = totals[idx];
                  const diff = deltas[idx];
                  const sign = diff > 0 ? "+" : "";
                  return [
                    ` Acumulado: ${total} pedidos`,
                    ` Variaci√≥n vs. hora anterior: ${sign}${diff}`
                  ];
                }
              }
            }
          }
        }
      });

      chartDelta = new Chart(document.getElementById("chartDelta"), {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Incremento por hora",
            data: deltas,
            backgroundColor: deltas.map(d =>
              d > 0 ? "#5ff97c" : (d < 0 ? "#ff6f6f" : "rgba(255,255,255,0.25)")
            )
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: { y: { ticks: { precision: 0 } } },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y || 0;
                  const sign = v > 0 ? "+" : "";
                  return ` Œî pedidos: ${sign}${v}`;
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
